# 生成树协议STP

## 交换环路
交换机互相之间连接成环路之后，称为交换环路，交换环路会导致以下危害：
1. 广播风暴：一台交换机收到的广播帧会在环路中不停的传播
2. 帧复制：在传播的过程中会不停的进行帧复制
3. MAC表震荡：在传播的过程中，交换机的MAC表将会不停的发生变化

## 生成树协议
通过将环路逻辑断线的方式，解决交换环路中广播风暴的问题。在线路出现故障时，激活被逻辑断线的线路，提高可靠性

### 配置BPDU
1. 选择根交换机(RB)：选择网桥ID最小的交换机为根交换机，网桥ID=优先级(2字节) 拼接 MAC地址
2. 选择根端口(RP)：根端口在非根交换机上进行选择，每台非根交换机均需要一个根端口，从上到下根据以下标准选择
   1. 本端口到达根网桥路径成本(开销值)最低
   2. 端口直连的网桥ID最小
   3. 端口直连端口ID最小 端口ID=端口优先级(1字节) 拼接 端口编号
3. 选择指定端口(DP)
   - 根网桥上的端口，都是指定端口
   - 在无DP或RP的线路的两个端口中，选出一个指定端口，从上到下进行选择
     1. 端口所在交换机的根路径成本较低
     2. 端口所在交换机的网桥ID值较小
     3. 端口ID的值较小
4. 阻塞所有既不是DP，也不是RP的端口，使该端口连接的线路作为备用线路

### 根路径成本
| 链路带宽 | 路径成本 |
| -------- | -------- |
| 10       | 100      |
| 100      | 19       |
| 1000     | 4        |
| 10000    | 2        |

### BPDU状态流转
1. 阻塞：所有端口初始状态均为阻塞，持续20s
2. 监听：开始发送并监听BPDU报文，并计算出需要阻塞的端口，持续15s
3. 学习：学习其余交换的MAX端口映射表，持续15s
4. 转发：所有RP或者DP端口进入转发状态，其余接口进入阻塞状态

### 端口状态
交换机的端口启用stp后，端口可能存在以下几种状态
1. 禁用(disable)：该状态可能是由于端口的物理状态导致，也可能是管理员手工将端口关闭
2. 阻塞(blocking)：该状态的端口不参与数据转发，但可以接收配置BPDU消息，并交由CPU进行处理。不能发送配置BPDU消息，也不能进行地址学习
3. 监听(listening)：该状态的端口不参与数据转发，也不进行地址学习，但可以接收并发送配置BPDU消息
4. 学习(learning)：该状态的端口不参与数据转发，但是开始地址学习，并且可以接收、发送、处理配置BPDU消息
5. 转发(forwarding)：该状态的端口可以转发任何数据，同时也可以进行地址学习，并且可以接收、发送、处理配置BPDU消息