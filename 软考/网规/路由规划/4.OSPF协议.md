# OSPF协议
开放最短路径优先协议，使用SPF算法计算路径开销，属于链路状态通告(LSA)协议中的一种

## SPF(最短路径优先)算法
SPF与到达目的网络的出接口带宽(开销)相关
1. 默认开销值COST=100/带宽Mbps    带宽越大，开销越小
2. 小于1的开销将会被设置为1
3. 最短路径是开销值最小的路径

## 特点
1. 支持无类域间路由CIDR
2. 无路由自环
3. 收敛速度快
4. 使用IP组播收发协议数据
5. 支持多条等值路由
6. 支持协议报文认证，区域认证和接口认证

## 区域类型
| 区域类型                                | 作用                                                                        | 说明                                                                                                                |
| --------------------------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| 骨干区域                                |                                                                             | 区域号为0的区域                                                                                                     |
| 非骨干区域                              |                                                                             | 区域号不为0的区域                                                                                                   |
| 普通区域                                |                                                                             | 包括标准区域和骨干区域                                                                                              |
| Stub(末梢、存根)区域                    | 位于自治系统的边界，只有一个ARB的非骨干区域，不学习外部路由，路由表信息较少 | Stub区域的ARB会发布一条默认路由，供Stub区域路由至外部网络。如果Stub区域被配置为完全Stub区域，则也不会学习区域间路由 |
| NSSA(Not-So-Stubby Area 非完全末梢)区域 | Stub区域的变形，只学习自己引进的外部路由，不学其他外部路由                  |                                                                                                                     |

## 路由器类别
| 类型                   | 含义                                                                                                                                          |
| ---------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| 区域内路由器IR         | 该类路由器的所有接口都属于同一个OSPF区域                                                                                                      |
| 区域边界路由器ARB      | 该类路由器至少有一个接口属于骨干区域同时还有接口连接非骨干区域。ARB用于连接骨干和非骨干区域，它与骨干区域的连接既可以是物理的，也可以是逻辑的 |
| 骨干路由器BR           | 该类路由器至少有一个接口属于骨干区域。所有的ARB和位于Area0的内部设备都是骨干路由器                                                            |
| 自治系统边界路由器ASBR | 与其他AS交换路由信息的设备称为ASBR，只要一台OSPF设备引入了外部路由信息，它就是ASBR                                                            |

## OSPF报文类型
| 报文类型             | 作用                                                                                 | LSA信息                               |
| -------------------- | ------------------------------------------------------------------------------------ | ------------------------------------- |
| Hello                | 发现和维护邻居关系                                                                   | 无                                    |
| Database Description | 发送链路状态数据库(LSDB)摘要信息，以便邻居判断应该请求哪些LSA                        | 仅LSA头部信息                         |
| Link State Request   | 请求特定的链路状态信息，双方成功交换Database Description报文后，才会向对方发出此报文 | 仅LSA Type、LS ID和Advertising Router |
| Link State Update    | 发送详细的链路状态信息                                                               | 完整的LSA信息                         |
| Link State Ack       | 发送确认报文，用来对收到的LSA进行确认                                                | LSA头部信息                           |

## 邻居和邻接
1. 邻居neighbor：2-way状态下建立的关系，仍未交换路由信息，只是知道对方的存在
2. 邻接adjacency：full状态下建立的关系，相互交换LSA，生成路由表

## 工作步骤
1. 通过交互Hello报文形成邻居关系，生成邻居关系表
2. 通过LSA泛洪通告链路状态信息，并收集邻居发出的LSA，生成LSA数据库
3. 计算路由，生成OSPF路由表
   1. 通过组建LSDB形成带权有向图(整个网络的拓扑结构)
   2. 通过SPF算法计算并形成路由开销和路由条目
   3. 维护和更新路由表

## 邻居关系建立流程
1. R1发送Hello报文
2. R2收到R1的Hello报文后进入Init状态，并发送Hello报文，Hello报文中表明R1已被发现为邻居
3. R1收到R2的Hello报文后进入2-Way状态，并发送Hello报文，Hello报文中表明R2已被发现为邻居
4. R2收到Hello报文后进入2-Way状态
5. (在广播型网络中，进入2-Way状态的路由器还会选举DR和BDR)

## 邻接关系建立流程
1. R1发送空的(无LSA信息)DD报文，只包含router-id，进入Exchange Start状态
2. R2发送空的DD报文，只包含router-id，进入Exchange Start状态
3. 双方比较router-id，以Router-id更大的作为主设备，从设备至此后发送的DD报文将会使用主设备的DD报文序列号
4. 从设备发送真实DD报文到主设备，主设备进入Exchange状态
5. 主设备发送真实DD报文到从设备，从设备进入Exchange状态，
6. 从设备发送完DD报文后最后一次发送空的DD报文表示已发送完毕
7. 主设备发送完DD报文后一直回应空的DD报文直到收到空的DD报文，4-7步严格有序
8. 至此双方都获取到了对方的LSDB信息，知道自己缺少哪些LSA
9. 一方向另一方发送Link State Request报文来请求LSA记录，进入Loading状态
10. 另一方收到Link State Request，进入Loading状态，发送Link State Update报文返回请求的LSA记录
11. 一方收到Link State Update报文后，返回Link State Ack报文
12. 双方请求完所有需要的LSA之后，完成LSDB同步，进入Full状态，形成邻接关系

## DR与BDR
在广播型网络中(交换型)中，如果多台OSPF设备同时接入，会形成mesh连接，严重影响带宽和设备性能。
1. DR：指定路由器
2. BDR：备份指定路由器，DR故障时，BDR将会成为DR
3. 设备优先级最大的设备将成为DR，第二高的设备成为BDR
   1. 优先级可以手动设置，默认为1
   2. 优先级为0的不参与DR和BDR选举
   3. 优先级一样，router-id更大的作为DR
4. 只有DR和BDR能与其余路由器建立邻接关系，其余路由器之间停留在2-Way状态
5. DR/BDR监听组播地址`224.0.0.6`，其他路由器监听组播地址`224.0.0.5`，IP协议号89
6. 先选举BDR，再选举DR

## 虚连接
1. 建立虚连接的两台路由器必须处于冲一个区域中
2. 建立虚连接的两台路由器会在Type1Type2生成的路由网络中传递虚连接所需的报文
3. 非骨干区域中用于建立虚连接的接口会被直接视作区域0中的接口
4. 虚连接路由记录的开销值需要加上虚连接本身的开销值

## 路由汇聚
路由汇聚发生在ABR上，汇总只能发生在同一个区域中
1. 汇总会抑制明细
2. 汇总会抑制震荡：不会因为区域中某一条明细路由的消息而删除对应的汇总路由，只要有一条明细的存在，汇总路由就不会被删除