# TCP

## 报文首部
1. 源端口           2B
2. 目的端口         2B
3. 序号             4B：该次报文数据的起始字节数
4. 确认号           4B：发送方希望接收方下次发送的开始序号
5. 数据偏移+保留+6位控制位 2B
6. 窗口                 2B：指剩余接收缓存窗口长度，发送方收到此信息后，将会把下次发送的数据长度控制在窗口长度内
7. 校验和               2B
8. 紧急指针             2B：紧急数据的长度
9. 选项                 可变
10. 填充                填充到4B的整数倍

## 数据偏移
长度4bit指TCP报文的首部长度，无选项时为20(B)

## 控制位
1. URG：紧急指针，为1时表示有紧急数据
2. ACK：确认指针，为1时表示该报文为确认同步或终止指针使用
3. PSH：推送指针，为1时表示该数据不经过系统缓存，直接发送到应用程序
4. RST：重置指针，为1时表示TCP连接出现错误或是一个非法的报文，重置或拒绝该连接
5. SYN：同步指针，为1时表示该报文为三次握手同步使用
6. FIN：终止指针，为1时表示断开连接

## 四次挥手
1. 客户端发送FIN=1，从ESTABLISHED状态变为FIN-WAIT1
2. 服务端收到FIN=1后，发送ACK=1，从ESTABLISHED状态变为CLOSE-WAIT，准备关闭事项，并发送剩余数据
3. 客户端收到ACK=1，从FIN-WAIT1状态变化FIN-WAIT2
4. 服务端完成关闭事项后，发送FIN=1，从CLOSE-WAIT状态变为LAST-ACK
5. 客户端收到FIN=1后，发送ACK=1，从FIN-WAIT2变为TIME-WAIT，持续时长2MSL，从TIME-WAIT状态变为CLOSED
6. 服务端收到ACK=1后，从LAST-ACK变为CLOSED状态

## 流量控制
利用可变大小的滑动窗口进行流量控制

## 拥塞控制
使用拥塞窗口来进行拥塞控制
1. 慢开始：拥塞窗口的初始长度设置较短，如果正常收到ACK，则翻倍拥塞窗口
2. 拥塞避免：慢开始直到某阈值，将长度设置为阈值，再以恒定速度扩大拥塞窗口。再出现第一次超时后，将拥塞窗口长度置为最小值，并将该阈值减半
3. 快恢复：在拥塞避免过程中，如果未收到超时，而是收到三次重复的ACK，则将拥塞窗口减半，继续拥塞避免
4. 快重传：接收方收到某失序报文后，会尽早重复确认最近一次有序报文，并且再后序报文中再进行重复确认

## 重传计时器
发送方再发送报文后启动计时器，如果在超时时间内未收到对应的ACK报文，则进行重传

## 坚持计时器
用于防止0窗口死锁，接收方收到win=0的报文段后，如果在超时时间后仍未收到win>0的报文段，则发送一个探测数据报文

## 保活计时器
接收方未收到发送方的报文，到达一定超时时间后，将会连续10次发送探测数据报文，如果均无回应，则断开连接

## 时间等待计时器
主动关闭方进入TIME-WAIT后，会等待2MSL的时间，防止最后一次挥手的ACK报文丢失