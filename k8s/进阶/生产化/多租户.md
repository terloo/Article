# 多租户

## 租户
1. 租户是一组拥有特定访问软件资源访问权限的用户集合，在多租户环境下，它还包括共享的应用、服务、数据和各项配置等
2. 多租户集群必须将租户彼此隔离，以最大限度的减少租户与租户、租户与集群之间的影响
3. 集群须在租户之间公平地分配集群资源。通过多租户共享集群资源，可以有效降低集群管理成本，提高集群整体资源利用率

## 认证
认证是实现租户的基础
1. 租户管理首先需要识别访问的用户是谁，因此用户身份认证是多租户系统的基础
2. 权限控制，允许合法登录的用户访问、拒绝非法登录的用户访问或者提供有限的匿名访问
3. k8s可管理两类用户
   1. 用来标识和管理系统组件的ServiceAccount
   2. 外部用户的认证，需要通过k8s的认证扩展来对接企业、供应商的认证服务，为用户验证、操作授权、资源隔离等提供基础

## 隔离
除认证、授权这些基础条件外，还要能够保证用户的工作负载彼此之间有尽可能安全的隔离，减少用户工作负载之间的影响。通常从权限、网络、数据三个方面对不同的用户进行隔离
1. Namespace：k8s中的Namespace属于且仅属于一个租户
2. 权限定义：定义内容包括命名空间中的Role和RoleBinding。表示目前租户在归属于自己命名空间中定义了什么权限、授权给租户哪些用户
3. Pod安全策略：特殊权限指集群级别的特定资源定义PodSecurityPolicy。定义了一系列工作负载与基础设施之间、工作负载与工作负载之间的关联关系，并通过RoleBinding完成授权
4. 网络策略：基础设施层面为保障租户网络的隔离机制提供了一系列默认策略，以及租户自己定制的用于租户应用彼此访问的策略
5. Pod、Service、PVC等命名空间资源：落地为k8s的实体
6. 权限隔离
   1. 基于Namespace的权限隔离
      1. 创建一个namespace-admin ClusterRole，拥有所有对象的所有权限
      2. 为租户开辟新的namespace，并在该namespace创建rolebinding绑定namespace-admin ClusterRole，用户即可拥有该命名空间所有对象的操作权限
   2. 自动化解决方案
      1. 当Namespace创建时，通过mutatingwebhook修改namespace，将用户信息记录至namespace annotation
      2. 创建一个Controller，监控namespace，创建一个rolebinding为该用户绑定namespace-admin的权限

## 资源配额管理
1. 开启ResoueceQuota准入插件
2. 在用户namespace创建ResourceQuota对象进行配额配置

## 节点资源隔离
1. 为不同的节点设置不同taint来识别不同租户的计算资源
2. 不同租户创建Pod时，为其添加对应的Toleration，确保能调度到某个taint节点