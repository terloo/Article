# 集群

## 解决的问题
1. 海量数据存储的问题：将索引库从逻辑上拆分为N个分片(shard)，存储到不同的节点
2. 单点故障问题：将分片数据在**不同的节点**上进行备份(replica)

## 节点类型
每个节点都可以有一个或多个身份
| 节点类型        | 配置参数    | 默认值 | 节点职责                                       |
| --------------- | ----------- | ------ | ---------------------------------------------- |
| master eligible | node.master | true   | 备选主节点                                     |
| data            | node.data   | true   | 数据节点                                       |
| ingest          | node.ingest | true   | 数据存储之前的预处理                           |
| coordinating    | 无          | 无     | 路由到其他节点，合并其他节点的处理结果，并返回 |

> 主节点：可以管理和记录集群状态、决定分片在哪个节点、处理创建和删除索引库的请求
> 备选主节点：可以成为主节点的节点，在未成为主节点时，参与选举并作为其他节点类型工作
> 数据节点：存储数据、搜索、聚合、CRUD
> coordinating：每个节点都至少有此身份

## 创建索引库时，配置分片信息
```json
{
    "settings": {
        "number_of_shards": 3,  // 分片数量
        "number_of_replicas": 1 // 副本数量
    }
}
```

## 分布式存储
es通过公式`shard = hash(_routing) % number_of_shards`来计算文档应该被存储到哪个分片，由于公式的限制，一旦索引库被创建出来，分片数便无法进行修改
> _routing默认为文档id

## 分布式查询
es分布式查询分为两个阶段
1. scatter phase：分散阶段，coordinating node会把请求分散到每个分片
2. gatther phase：coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户

## 故障转移
集群中的master节点(包括通过选举产生的)会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其他节点，确保数据安全，称为故障转移
